name: Sync and Update hweb Documentation

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no push)'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'

env:
  TARGET_REPO: engels74/hweb
  UPSTREAM_REPO: hotio/website
  UPSTREAM_BRANCH: master
  TARGET_BRANCH: master

jobs:
  sync_hweb_website:
    runs-on: ubuntu-latest
    steps:
      # ============================================================
      # STEP 1: Checkout target repository (engels74/hweb)
      # ============================================================
      - name: Checkout Target Repository
        uses: actions/checkout@v6
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0
          path: target

      # ============================================================
      # STEP 2: Checkout repo-patches for custom content
      # ============================================================
      - name: Checkout Repo Patches
        uses: actions/checkout@v6
        with:
          repository: engels74/repo-patches
          token: ${{ secrets.GH_PAT }}
          path: patches
          ref: main

      # ============================================================
      # STEP 3: Configure Git
      # ============================================================
      - name: Configure Git
        working-directory: ./target
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # ============================================================
      # STEP 4: Add and fetch upstream repository
      # ============================================================
      - name: Add Upstream Repository
        working-directory: ./target
        run: |
          set -e
          echo "Adding upstream remote..."
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git" || true
          echo "Fetching upstream ${{ env.UPSTREAM_BRANCH }}..."
          git fetch upstream "${{ env.UPSTREAM_BRANCH }}"
          echo "Upstream fetch complete."

      # ============================================================
      # STEP 5: Hard reset to upstream (clean slate)
      # ============================================================
      - name: Reset to Upstream
        working-directory: ./target
        run: |
          set -e
          echo "Resetting to upstream/${{ env.UPSTREAM_BRANCH }}..."
          git checkout -B "${{ env.TARGET_BRANCH }}" "upstream/${{ env.UPSTREAM_BRANCH }}"
          echo "Reset complete. Now at commit:"
          git log -1 --oneline

      # ============================================================
      # STEP 6: Verify required source files exist (fail fast)
      # ============================================================
      - name: Verify Patch Files Exist
        run: |
          set -e
          echo "============================================"
          echo "Verifying required patch files..."
          echo "============================================"

          REQUIRED_FILES=(
            "patches/hweb-content/config/mkdocs.yml"
            "patches/hweb-content/docs/index.md"
            "patches/hweb-content/docs/faq.md"
            "patches/hweb-content/docs/CNAME"
            "patches/hweb-content/docs/containers/base-image.md"
            "patches/hweb-content/docs/containers/caddy.md"
            "patches/hweb-content/docs/containers/obzorarr.md"
            "patches/hweb-content/docs/containers/overseerr-anime.md"
            "patches/hweb-content/docs/containers/qbittorrent.md"
            "patches/hweb-content/docs/containers/qflood.md"
            "patches/hweb-content/docs/containers/sabnzbd.md"
            "patches/hweb-content/docs/containers/tgraph-bot.md"
            "patches/hweb-content/assets/img/engels74.svg"
          )

          MISSING_FILES=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [[ ! -f "$file" ]]; then
              MISSING_FILES+=("$file")
              echo "ERROR: Missing required file: $file"
            else
              echo "OK: $file"
            fi
          done

          if [[ ${#MISSING_FILES[@]} -gt 0 ]]; then
            echo ""
            echo "=========================================="
            echo "FATAL: ${#MISSING_FILES[@]} required file(s) missing!"
            echo "=========================================="
            echo "Please ensure all required files exist in the repo-patches repository."
            exit 1
          fi

          echo ""
          echo "All required patch files verified successfully."

      # ============================================================
      # STEP 7: Delete unwanted container documentation
      # ============================================================
      - name: Delete Unwanted Container Docs
        working-directory: ./target
        run: |
          set -e
          echo "============================================"
          echo "Deleting unwanted container documentation..."
          echo "============================================"

          # Define containers to KEEP (inverse logic - delete everything else)
          # This approach handles upstream adding/removing containers automatically
          declare -A CONTAINERS_TO_KEEP=(
            ["base-image.md"]=1
            ["caddy.md"]=1
            ["obzorarr.md"]=1
            ["overseerr-anime.md"]=1
            ["qbittorrent.md"]=1
            ["qflood.md"]=1
            ["sabnzbd.md"]=1
            ["tgraph-bot.md"]=1
          )

          DELETED_COUNT=0
          if [[ -d "docs/containers" ]]; then
            for filepath in docs/containers/*.md; do
              if [[ -f "$filepath" ]]; then
                filename=$(basename "$filepath")
                if [[ -z "${CONTAINERS_TO_KEEP[$filename]}" ]]; then
                  rm -v "$filepath"
                  DELETED_COUNT=$((DELETED_COUNT + 1))
                else
                  echo "Keeping: $filename"
                fi
              fi
            done
          fi

          echo ""
          echo "Deleted $DELETED_COUNT unwanted container doc(s)."

      # ============================================================
      # STEP 8: Delete scripts folder entirely
      # ============================================================
      - name: Delete Scripts Folder
        working-directory: ./target
        run: |
          set -e
          echo "============================================"
          echo "Removing scripts folder..."
          echo "============================================"

          if [[ -d "docs/scripts" ]]; then
            rm -rfv docs/scripts
            echo "Deleted: docs/scripts/"
          else
            echo "INFO: docs/scripts/ not found (already removed)"
          fi

      # ============================================================
      # STEP 9: Delete guides folder entirely
      # ============================================================
      - name: Delete Guides Folder
        working-directory: ./target
        run: |
          set -e
          echo "============================================"
          echo "Removing guides folder..."
          echo "============================================"

          if [[ -d "docs/guides" ]]; then
            rm -rfv docs/guides
            echo "Deleted: docs/guides/"
          else
            echo "INFO: docs/guides/ not found (already removed)"
          fi

      # ============================================================
      # STEP 10: Replace mkdocs.yml with custom configuration
      # ============================================================
      - name: Replace mkdocs.yml
        run: |
          set -e
          echo "============================================"
          echo "Replacing mkdocs.yml with custom configuration..."
          echo "============================================"

          cp -v patches/hweb-content/config/mkdocs.yml target/mkdocs.yml

          if [[ ! -f "target/mkdocs.yml" ]]; then
            echo "ERROR: Failed to copy mkdocs.yml"
            exit 1
          fi

          echo ""
          echo "mkdocs.yml replaced successfully."
          echo "Navigation structure:"
          grep -A 20 "^nav:" target/mkdocs.yml || true

      # ============================================================
      # STEP 11: Copy custom documentation files
      # ============================================================
      - name: Copy Custom Documentation
        run: |
          set -e
          echo "============================================"
          echo "Copying custom documentation files..."
          echo "============================================"

          # Copy index.md (homepage)
          echo "Copying homepage..."
          cp -v patches/hweb-content/docs/index.md target/docs/index.md

          # Copy faq.md (with JavaScript redirect)
          echo "Copying FAQ..."
          cp -v patches/hweb-content/docs/faq.md target/docs/faq.md

          # Copy CNAME
          echo "Copying CNAME..."
          cp -v patches/hweb-content/docs/CNAME target/docs/CNAME

          # Ensure containers directory exists
          mkdir -p target/docs/containers

          # Copy all container documentation
          CONTAINERS=(
            "base-image.md"
            "caddy.md"
            "obzorarr.md"
            "overseerr-anime.md"
            "qbittorrent.md"
            "qflood.md"
            "sabnzbd.md"
            "tgraph-bot.md"
          )

          echo ""
          echo "Copying container documentation..."
          for container in "${CONTAINERS[@]}"; do
            src="patches/hweb-content/docs/containers/$container"
            dst="target/docs/containers/$container"

            if [[ -f "$src" ]]; then
              cp -v "$src" "$dst"
            else
              echo "ERROR: Source file not found: $src"
              exit 1
            fi
          done

          echo ""
          echo "Custom documentation copied successfully."

      # ============================================================
      # STEP 12: Copy custom assets (logos, images)
      # ============================================================
      - name: Copy Custom Assets
        run: |
          set -e
          echo "============================================"
          echo "Copying custom assets..."
          echo "============================================"

          # Ensure directories exist
          mkdir -p target/docs/img/image-logos

          # Copy engels74.svg (main logo)
          if [[ -f "patches/hweb-content/assets/img/engels74.svg" ]]; then
            cp -v patches/hweb-content/assets/img/engels74.svg target/docs/img/engels74.svg
            echo "Copied: engels74.svg"
          else
            echo "ERROR: engels74.svg not found!"
            exit 1
          fi

          # Copy custom container logos if they exist
          if [[ -d "patches/hweb-content/assets/img/image-logos" ]]; then
            for logo in patches/hweb-content/assets/img/image-logos/*; do
              if [[ -f "$logo" ]]; then
                cp -v "$logo" target/docs/img/image-logos/
                echo "Copied logo: $(basename "$logo")"
              fi
            done
          fi

          echo ""
          echo "Custom assets copied successfully."

      # ============================================================
      # STEP 13: Clean up unused upstream images
      # ============================================================
      - name: Cleanup Unused Images
        working-directory: ./target
        run: |
          set -e
          echo "============================================"
          echo "Cleaning up unused image logos..."
          echo "============================================"

          # Logos to KEEP (needed for engels74 containers)
          # Using associative array for fast lookup
          declare -A KEEP_LOGOS=(
            ["base-image.svg"]=1
            ["base-image.png"]=1
            ["caddy.svg"]=1
            ["caddy.png"]=1
            ["flood.svg"]=1
            ["flood.png"]=1
            ["obzorarr.svg"]=1
            ["obzorarr.png"]=1
            ["overseerr.svg"]=1
            ["overseerr.png"]=1
            ["qbittorrent.svg"]=1
            ["qbittorrent.png"]=1
            ["qflood.svg"]=1
            ["qflood.png"]=1
            ["sabnzbd.svg"]=1
            ["sabnzbd.png"]=1
            ["tgraph-bot.svg"]=1
            ["tgraph-bot.png"]=1
          )

          DELETED_COUNT=0
          if [[ -d "docs/img/image-logos" ]]; then
            for logo_file in docs/img/image-logos/*; do
              if [[ -f "$logo_file" ]]; then
                filename=$(basename "$logo_file")
                if [[ -z "${KEEP_LOGOS[$filename]}" ]]; then
                  rm -v "$logo_file"
                  DELETED_COUNT=$((DELETED_COUNT + 1))
                else
                  echo "Keeping: $filename"
                fi
              fi
            done
          fi

          echo ""
          echo "Deleted $DELETED_COUNT unused logo(s)."

      # ============================================================
      # STEP 14: Clean up pullio-related and script images
      # ============================================================
      - name: Cleanup Script-Related Files
        working-directory: ./target
        run: |
          set -e
          echo "============================================"
          echo "Cleaning up script-related files..."
          echo "============================================"

          # Remove pullio images (not needed since scripts section removed)
          PULLIO_FILES=(
            "docs/img/pullio-background-crying.png"
            "docs/img/pullio-background-sunglasses.png"
            "docs/img/pullio-background.png"
            "docs/img/pullio-cat.svg"
            "docs/img/pullio-crying.svg"
            "docs/img/pullio-grimacing.svg"
            "docs/img/pullio-hearts.svg"
            "docs/img/pullio-laugh-tears.svg"
            "docs/img/pullio-puking.svg"
            "docs/img/pullio-sunglasses.svg"
            "docs/img/pullio-tear.svg"
            "docs/img/pullio-update-1.png"
            "docs/img/pullio-update-2.png"
            "docs/img/pullio-update-3.png"
            "docs/img/pullio-update-4.png"
            "docs/img/pullio-update-5.png"
            "docs/img/pullio.svg"
            "docs/img/pullio-stick-out-tongue.svg"
            "docs/img/arr-discord-notifier-1.png"
            "docs/img/arr-discord-notifier-2.png"
            "docs/img/arr-discord-notifier-3.png"
            "docs/img/sysinfo.png"
          )

          DELETED_COUNT=0
          for file in "${PULLIO_FILES[@]}"; do
            if [[ -f "$file" ]]; then
              rm -v "$file"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            fi
          done

          echo ""
          echo "Deleted $DELETED_COUNT script-related file(s)."

      # ============================================================
      # STEP 15: Clean up unused webhook avatars
      # ============================================================
      - name: Cleanup Unused Webhook Avatars
        working-directory: ./target
        run: |
          set -e
          echo "============================================"
          echo "Cleaning up unused webhook avatars..."
          echo "============================================"

          # Avatars to KEEP (for engels74 containers)
          declare -A KEEP_AVATARS=(
            ["caddy.png"]=1
            ["flood.png"]=1
            ["hotio.png"]=1
            ["obzorarr.png"]=1
            ["overseerr.png"]=1
            ["qbittorrent.png"]=1
            ["sabnzbd.png"]=1
          )

          DELETED_COUNT=0
          if [[ -d "docs/webhook-avatars" ]]; then
            for avatar_file in docs/webhook-avatars/*; do
              if [[ -f "$avatar_file" ]]; then
                filename=$(basename "$avatar_file")
                if [[ -z "${KEEP_AVATARS[$filename]}" ]]; then
                  rm -v "$avatar_file"
                  DELETED_COUNT=$((DELETED_COUNT + 1))
                else
                  echo "Keeping: $filename"
                fi
              fi
            done
          fi

          echo ""
          echo "Deleted $DELETED_COUNT unused avatar(s)."

      # ============================================================
      # STEP 16: Verify final structure
      # ============================================================
      - name: Verify Final Structure
        working-directory: ./target
        run: |
          set -e
          echo "============================================"
          echo "Verifying final file structure..."
          echo "============================================"

          EXPECTED_FILES=(
            "mkdocs.yml"
            "docs/index.md"
            "docs/faq.md"
            "docs/CNAME"
            "docs/containers/base-image.md"
            "docs/containers/caddy.md"
            "docs/containers/obzorarr.md"
            "docs/containers/overseerr-anime.md"
            "docs/containers/qbittorrent.md"
            "docs/containers/qflood.md"
            "docs/containers/sabnzbd.md"
            "docs/containers/tgraph-bot.md"
            "docs/img/engels74.svg"
            "includes/annotations.md"
            "includes/tags.md"
            "includes/wireguard.md"
            "includes/header-links.md"
          )

          ERRORS=0
          for file in "${EXPECTED_FILES[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "ERROR: Missing expected file: $file"
              ERRORS=$((ERRORS + 1))
            else
              echo "OK: $file"
            fi
          done

          # Verify scripts folder is removed
          if [[ -d "docs/scripts" ]]; then
            echo "ERROR: docs/scripts/ should have been deleted"
            ERRORS=$((ERRORS + 1))
          else
            echo "OK: docs/scripts/ removed"
          fi

          # Verify guides folder is removed
          if [[ -d "docs/guides" ]]; then
            echo "ERROR: docs/guides/ should have been deleted"
            ERRORS=$((ERRORS + 1))
          else
            echo "OK: docs/guides/ removed"
          fi

          # Verify unwanted containers are removed (spot check)
          UNWANTED_CONTAINERS=("radarr.md" "sonarr.md" "plex.md")
          for container in "${UNWANTED_CONTAINERS[@]}"; do
            if [[ -f "docs/containers/$container" ]]; then
              echo "ERROR: Unwanted container doc still present: $container"
              ERRORS=$((ERRORS + 1))
            fi
          done

          echo ""
          if [[ $ERRORS -gt 0 ]]; then
            echo "=========================================="
            echo "FATAL: $ERRORS verification error(s) found!"
            echo "=========================================="
            exit 1
          fi

          echo "Final structure verification passed."
          echo ""
          echo "Container docs present:"
          ls -la docs/containers/

      # ============================================================
      # STEP 17: Show diff summary
      # ============================================================
      - name: Show Changes Summary
        working-directory: ./target
        run: |
          echo "============================================"
          echo "Changes Summary"
          echo "============================================"

          echo ""
          echo "Files changed:"
          git status --porcelain | head -50

          echo ""
          echo "Total files changed: $(git status --porcelain | wc -l)"

      # ============================================================
      # STEP 18: Commit and push changes
      # ============================================================
      - name: Commit and Push Changes
        working-directory: ./target
        run: |
          set -e

          echo "============================================"
          echo "Committing and pushing changes..."
          echo "============================================"

          if [[ -n $(git status --porcelain) ]]; then
            echo "Changes detected. Staging all files..."
            git add .

            echo "Creating commit..."
            git commit -m "Sync with upstream (hotio/website) and apply engels74 customizations

            - Hard reset to upstream hotio/website
            - Applied custom mkdocs.yml with engels74 navigation
            - Replaced container docs with engels74 versions
            - Removed scripts and guides sections
            - Cleaned up unused images and avatars

            Automated sync by GitHub Actions"

            if [[ "${{ inputs.dry_run }}" == "true" ]]; then
              echo ""
              echo "=========================================="
              echo "DRY RUN MODE - Skipping push"
              echo "=========================================="
              echo "Would have pushed the following commit:"
              git log -1 --oneline
              echo ""
              echo "Changed files:"
              git diff --stat HEAD~1
            else
              echo "Pushing changes to origin/${{ env.TARGET_BRANCH }}..."
              git push origin "${{ env.TARGET_BRANCH }}" --force
              echo ""
              echo "=========================================="
              echo "Push complete!"
              echo "=========================================="
            fi
          else
            echo "No changes detected after modifications."
            echo "The target repository is already in sync."
          fi

      # ============================================================
      # STEP 19: Summary
      # ============================================================
      - name: Workflow Summary
        if: always()
        run: |
          echo "============================================"
          echo "Workflow Complete"
          echo "============================================"
          echo ""
          echo "Target Repository: ${{ env.TARGET_REPO }}"
          echo "Upstream Repository: ${{ env.UPSTREAM_REPO }}"
          echo "Dry Run: ${{ inputs.dry_run }}"
          echo ""
          echo "The engels74-hweb documentation site has been synced with upstream and customized."
          echo "Deployment will be triggered automatically by the GitHub Pages workflow in the target repo."
